<!DOCTYPE html>
<html>
  <head>
    <title>Ocean Backup</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .form-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      input,
      textarea {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button {
        padding: 8px 16px;
        background-color: #0066cc;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0052a3;
      }
      button.secondary {
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ccc;
      }
      button.secondary:hover {
        background-color: #e0e0e0;
      }
      #saveCredentialsBtn {
        display: none;
      }
      .drop-zone {
        border: 2px dashed #ccc;
        padding: 20px;
        text-align: center;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Ocean Backup Utility</h1>

      <div class="form-group">
        <h2>API Credentials</h2>
        <input type="text" id="clientId" placeholder="Ocean Client ID" />
        <input
          type="password"
          id="clientSecret"
          placeholder="Ocean Client Secret"
        />
        <button id="saveCredentialsBtn" onclick="saveCredentials()">
          Save Credentials
        </button>
      </div>

      <div class="form-group">
        <h2>Referrals</h2>
        <button class="secondary" onclick="selectInputFile()">
          Select Input File
        </button>
        <textarea
          id="refList"
          placeholder="Enter Referral References (one per line)"
          rows="5"
        ></textarea>
        <div id="ref-download-result"></div>

        <button class="secondary" onclick="selectOutputDirectory()">
          Select Output Directory
        </button>
        <div id="output-dir">Output Directory: Downloads</div>
        <div id="progress-container" style="display: none">
          <progress id="progress-bar" value="0" max="100"></progress>
          <div id="progress-text"></div>
        </div>
        <div id="results-container" style="display: none">
          <h3>Download Results</h3>
          <div id="results-text"></div>
        </div>
        <button onclick="downloadReferrals()">Download Referrals</button>
      </div>

      <div id="status"></div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      // Load saved credentials
      ipcRenderer.send("load-credentials");
      ipcRenderer.on("credentials-loaded", (event, credentials) => {
        if (credentials) {
          document.getElementById("clientId").value = credentials.clientId;
          document.getElementById("clientSecret").value =
            credentials.clientSecret;
          originalCredentials = {
            clientId: credentials.clientId,
            clientSecret: credentials.clientSecret,
          };
        }
      });

      // Add input change listeners to show/hide save button
      const credentialInputs = ["clientId", "clientSecret"];
      let originalCredentials = {
        clientId: "",
        clientSecret: "",
      };

      credentialInputs.forEach((id) => {
        document
          .getElementById(id)
          .addEventListener("input", checkCredentialChanges);
      });

      function checkCredentialChanges() {
        const currentCredentials = {
          clientId: document.getElementById("clientId").value,
          clientSecret: document.getElementById("clientSecret").value,
        };

        const hasChanges =
          currentCredentials.clientId !== originalCredentials.clientId ||
          currentCredentials.clientSecret !== originalCredentials.clientSecret;

        document.getElementById("saveCredentialsBtn").style.display = hasChanges
          ? "block"
          : "none";
      }

      // Update the credentials loaded handler to set original values
      ipcRenderer.on("credentials-loaded", (event, credentials) => {
        if (credentials) {
          document.getElementById("clientId").value = credentials.clientId;
          document.getElementById("clientSecret").value =
            credentials.clientSecret;
          originalCredentials = {
            clientId: credentials.clientId,
            clientSecret: credentials.clientSecret,
          };
        }
      });

      function saveCredentials() {
        const credentials = {
          clientId: document.getElementById("clientId").value.trim(),
          clientSecret: document.getElementById("clientSecret").value.trim(),
        };
        ipcRenderer.send("save-credentials", credentials);
        originalCredentials = { ...credentials };
        document.getElementById("saveCredentialsBtn").style.display = "none";
      }

      function downloadReferrals() {
        const refText = document.getElementById("refList").value;
        const manuallySpecifiedRefs = refText
          .split("\n")
          .map((line) => line.trim())
          .filter((line) => line.length > 0);
        const refs = [
          ...(window.refsToDownload || []),
          ...manuallySpecifiedRefs,
        ];
        if (refs.length === 0) {
          updateStatus("No references provided.");
          return;
        }

        ipcRenderer.send("download-referrals", refs);
      }

      function updateStatus(message) {
        document.getElementById("status").textContent = message;
      }

      // Status updates
      ipcRenderer.on("referral-downloaded", (event, { ref, filePath }) => {
        updateStatus(`Downloaded referral ${ref} to ${filePath}`);
      });

      ipcRenderer.on("download-error", (event, error) => {
        updateStatus(`Error: ${JSON.stringify(error)}`);
      });
      // Add these event listeners
      ipcRenderer.on("download-progress", (event, progress) => {
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");

        if (progressBar && progressText) {
          progressBar.value = progress.progress;
          progressText.textContent = `Downloaded ${progress.completed} of ${
            progress.total
          } files (${Math.round(progress.progress)}%)`;
        }
      });

      // Add button handler for output directory
      async function selectOutputDirectory() {
        const dir = await ipcRenderer.invoke("select-output-dir");
        if (dir) {
          document.getElementById(
            "output-dir"
          ).textContent = `Output Directory: ${dir}`;
        }
      }

      // Add function to handle file selection
      async function selectInputFile() {
        try {
          const result = await ipcRenderer.invoke("select-input-file");
          if (!result.success) {
            alert(`Error processing file: ${result.error}`);
            return;
          }

          const refs = result.refs;
          if (refs && refs.length > 0) {
            document.getElementById(
              "ref-download-result"
            ).textContent = `Found ${refs.length} Referral Reference${
              refs.length === 1 ? "" : "s"
            }`;
            window.refsToDownload = refs;
          } else {
            document.getElementById("ref-download-result").textContent =
              "No Referral References found in file";
          }
        } catch (error) {
          alert(`Error processing file: ${error.message || "Unknown error"}`);
        }
      }
      // Add these event listeners
      ipcRenderer.on("download-start", () => {
        document.getElementById("progress-container").style.display = "block";
        document.getElementById("results-container").style.display = "none";
        document.getElementById("progress-text").textContent =
          "Starting download...";
      });

      ipcRenderer.on("download-progress", (event, progress) => {
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");

        if (progressBar && progressText) {
          progressBar.value = progress.progress;
          progressText.textContent = `Downloaded ${progress.completed} of ${
            progress.total
          } files (${Math.round(progress.progress)}%)`;
        }
      });

      ipcRenderer.on("download-complete", (event, results) => {
        document.getElementById("progress-container").style.display = "none";
        document.getElementById("results-container").style.display = "block";

        const resultsText = document.getElementById("results-text");
        let message = ``;
        if (results.successful > 0) {
          message += `Successfully downloaded ${results.successful} Referral References to ${results.outputDir}`;
        }
        if (results.failed.length > 0) {
          message += `\n\nFailed to download ${results.failed.length} Referral References:`;
          results.failed.forEach((failure) => {
            message += `\nReferral Reference ${failure.ref}: ${failure.error}`;
          });
        }

        resultsText.textContent = message;
      });
    </script>
  </body>
</html>
